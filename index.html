<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>YOLOv8 Pro Detector</title>

    <!-- Ultralytics YOLO WASM -->
    <script src="https://cdn.jsdelivr.net/npm/@ultralytics/yolo@latest"></script>

    <style>
        :root{--bg:#000;--panel:rgba(20,20,20,0.7);--accent:lime}
        html,body{height:100%;margin:0}
        body{
            margin: 0;
            background: var(--bg);
            overflow: hidden;
            font-family: Arial, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue";
            color:#fff;
        }

        video, canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            object-fit: cover;
            touch-action: none;
        }

        #toolbar {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 99999;
            display: flex;
            gap: 8px;
            backdrop-filter: blur(6px);
        }
        #toolbar button {
            padding: 8px 14px;
            border: none;
            background: var(--panel);
            color: white;
            border-radius: 8px;
            font-size: 14px;
            border: 1px solid #444;
            cursor: pointer;
        }
        #toolbar button:hover { background: rgba(40,40,40,0.85) }

        #fps {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.5);
            color: var(--accent);
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 6px;
            z-index: 99999;
            font-family: monospace;
        }

        #loading {
            position: fixed; left:50%; top:50%; transform:translate(-50%,-50%);
            z-index:999999; font-size:18px; background:var(--panel); padding:12px 18px; border-radius:10px;
            border:1px solid #333;
        }

    </style>
</head>

<body>

    <div id="loading">Loading YOLOv8n model…</div>

    <!-- CONTROLS -->
    <div id="toolbar">
        <button id="backBtn">Back Cam</button>
        <button id="frontBtn">Front Cam</button>
        <button id="stealthBtn">Stealth</button>
        <button id="shotBtn">Screenshot</button>
        <button id="recordBtn">Record</button>
    </div>

    <div id="fps">FPS: 0</div>

    <video id="video" autoplay muted playsinline></video>
    <canvas id="canvas"></canvas>

    <script>
        // YOLOv8 Pro Detector - single-file web app
        // - client-side WASM model via ultralytics CDN
        // - camera permission (getUserMedia)
        // - front/back switch, stealth, screenshot, recording
        // - optimized loop with lightweight drawing

        let model;
        let stealthMode = false;
        let recording = false;
        let recorder = null;
        let videoChunks = [];

        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const fpsBox = document.getElementById('fps');
        const loading = document.getElementById('loading');

        // FPS counter
        let lastFPS = performance.now();
        let frameCount = 0;

        // Buttons
        document.getElementById('backBtn').addEventListener('click', () => switchCamera('environment'));
        document.getElementById('frontBtn').addEventListener('click', () => switchCamera('user'));
        document.getElementById('stealthBtn').addEventListener('click', () => toggleStealth());
        document.getElementById('shotBtn').addEventListener('click', () => takeShot());
        document.getElementById('recordBtn').addEventListener('click', () => toggleRecording());

        async function loadModel() {
            // load model (from CDN). This is async and can take time on slow devices.
            model = await YOLO.load('yolov8n');
            loading.style.display = 'none';
        }

        async function startCamera(facingMode = 'environment') {
            try {
                if (video.srcObject) {
                    video.srcObject.getTracks().forEach(t => t.stop());
                }

                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode },
                    audio: false
                });

                video.srcObject = stream;
                await video.play();
            } catch (err) {
                alert('Cannot access camera: ' + err.message);
                console.error(err);
            }
        }

        function switchCamera(mode) {
            startCamera(mode);
        }

        function toggleStealth() {
            stealthMode = !stealthMode;
            document.getElementById('stealthBtn').textContent = stealthMode ? 'Stealth ✓' : 'Stealth';
        }

        function takeShot() {
            // Download current canvas as PNG
            const link = document.createElement('a');
            link.download = `yolo_snapshot_${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        function toggleRecording() {
            if (!recording) startRecording(); else stopRecording();
        }

        function startRecording() {
            // captureStream from canvas
            const stream = canvas.captureStream(30);
            recorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9' });
            videoChunks = [];
            recorder.ondataavailable = e => { if (e.data && e.data.size) videoChunks.push(e.data); };
            recorder.onstop = saveRecording;
            recorder.start();
            recording = true;
            document.getElementById('recordBtn').textContent = 'Recording…';
        }

        function stopRecording() {
            if (recorder && recorder.state !== 'inactive') recorder.stop();
            recording = false;
            document.getElementById('recordBtn').textContent = 'Record';
        }

        function saveRecording() {
            const blob = new Blob(videoChunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `yolo_record_${Date.now()}.webm`;
            a.click();
            setTimeout(() => URL.revokeObjectURL(url), 10000);
        }

        async function detectLoop() {
            if (!video.videoWidth) {
                requestAnimationFrame(detectLoop);
                return;
            }

            // Resize canvas to match video size
            if (canvas.width !== video.videoWidth || canvas.height !== video.videoHeight) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
            }

            // Draw current frame
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Run prediction
            try {
                const result = await model.predict(video);
                const boxes = (result && result[0] && result[0].boxes) ? result[0].boxes : null;

                if (boxes && boxes.xyxy && boxes.xyxy.length) {
                    if (!stealthMode) {
                        // draw boxes
                        for (let i = 0; i < boxes.xyxy.length; i++) {
                            const [x1, y1, x2, y2] = boxes.xyxy[i];
                            const conf = boxes.conf[i];
                            const cls = boxes.cls[i];
                            const label = `${model.names[cls] || cls} ${conf.toFixed(2)}`;

                            // box
                            ctx.strokeStyle = 'lime';
                            ctx.lineWidth = Math.max(2, Math.round(canvas.width / 300));
                            ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);

                            // label background
                            ctx.fillStyle = 'rgba(0,0,0,0.6)';
                            const txtW = ctx.measureText(label).width + 8;
                            const txtH = 20;
                            ctx.fillRect(x1, y1 - txtH, txtW, txtH);

                            // label text
                            ctx.fillStyle = 'lime';
                            ctx.font = '16px Arial';
                            ctx.fillText(label, x1 + 4, y1 - 4);
                        }
                    }
                }
            } catch (err) {
                // prediction errors shouldn't break the loop
                console.warn('Prediction error', err);
            }

            // FPS
            frameCount++;
            const now = performance.now();
            if (now - lastFPS >= 1000) {
                fpsBox.textContent = `FPS: ${frameCount}`;
                frameCount = 0;
                lastFPS = now;
            }

            requestAnimationFrame(detectLoop);
        }

        async function init() {
            await loadModel();
            await startCamera('environment');
            detectLoop();
        }

        // Start app
        init();

    </script>
</body>
</html>
